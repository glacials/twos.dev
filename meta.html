<!doctype html>
<html lang="en">

<head>
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-2876079-11"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag() { dataLayer.push(arguments); }
    gtag('js', new Date());

    gtag('config', 'UA-2876079-11');
  </script>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <meta name="description" content='This Website'>
  <link rel="icon" href="favicon.ico">
  <link rel="alternate" type="application/rss+xml" title="twos.dev" href="/feed.rss" />
  <title>This Website</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    .spectrum {
      height: 10em;
      width: 10em;
      background: conic-gradient(
        hsl(0, 90%, 65%),
        hsl(36, 90%, 65%),
        hsl(72, 90%, 65%),
        hsl(108, 90%, 65%),
        hsl(144, 90%, 65%),
        hsl(180, 90%, 65%),
        hsl(216, 90%, 65%),
        hsl(252, 90%, 65%),
        hsl(288, 90%, 65%),
        hsl(324, 90%, 65%),
        hsl(360, 90%, 65%)
      );
      border: 1px solid;
      border-radius: 90%;
    }
    @media (prefers-color-scheme:light) {
      .spectrum {
        border-color: black;
      }
    @media (prefers-color-scheme:dark) {
      .spectrum {
        border-color: white;
      }
    }

    summary {
      cursor: pointer;
    }
  </style>
</head>

<body>
  <div class="container">
    <header>
      &larr; <a href="index.html">twos.dev</a>
      
        / 2022 May
      
    </header>
    <article><h1>The Bespoke Twos Deployment Pipeline</h1><p>The Twos CD pipeline has a unique advantage against anything I’ve ever worked on: it has just one user, me, so can be designed in what would otherwise be obnoxious and unintuitive ways to serve my peculiarities.</p><p>My two biggest goals for this pipeline:</p><ol><li>Encourage myself to write</li><li>URLs must never change</li></ol><p>To fulfill these goals, the Twos CD pipeline allows for two content types:</p><ul><li>Warm content</li><li>Cold content</li></ul><h2>On Writing</h2><p>I use <a href="https://ia.net/writer">iA Writer</a> to write drafts. It gets my thoughts out quickly, without mucking about in formatting or DOM. If I were writing for a personal diary, things would end there.</p><p>Because I like to publish, it's a problem that these drafts too often stay drafts.</p><p>Luckily, iA Writer stores documents as plaintext Markdown files. Normally, shipping these files to a Markdown parser would be a sufficient general solution.</p><p>But there are two peculiarities I’m allowing myself to indulge.</p><h3>Automatic Publishing</h3><p>Because I have trouble pulling the publish trigger, I’ve decided upfront that I need to make that trigger 10x easier to pull. For this case, a good path towards that is to pull the publishing process out of Git and into iA Writer itself, to allow easy publishing from even my phone.</p><h3>Mechanics</h3><p>iA Writer on macOS has some automation tools, but not a lot. It has the ability to store documents in services like Dropbox and Google Drive, but for <a href="apple.html">unrelated peculiarities</a> I limit myself to iCloud Drive for those purposes at the moment. Unfortunately, iCloud Drive has no native API or other way to reach files from within GitHub Actions. (TODO: Perhaps there’s a way to sign into an Apple ID on a GitHub Actions Mac? Perhaps not due to 2FA, or maybe an app-specific password would work?)</p><p>I keep infrastructure off my own devices when I can—I wipe my drives a lot—but it seems there is no way to avoid it if I need to ship files from iCloud Drive to GitHub Actions.</p><p>What I can do is automate this in a way that is resistant to my drive-wiping habits. And so far, the most resistant device I own to this, the only one I’m comfortable directly transferring to a replacement device using its migration tool, is my iPhone.</p><h4>Shortcuts</h4><p>Starting with iOS 13, all iPhones ship with an Apple app called <a href="https://apps.apple.com/us/app/shortcuts/id1462947752">Shortcuts</a>. If you’re from Android like I am, Shortcuts is like Tasker, if it were built into the operating system and had buy-in from every third-party app. For example, I use a shortcut to turn on my coffee machine every morning when I take my phone off its charger.</p><p>Shortcuts can therefore behave as an API gateway into iCloud Drive. I can set up a shortcut to run like a cron job, or even better, to run after I switch away from a specific app. It can inspect a directory in iCloud Drive (let’s make a “Published” directory), and do… something with it.</p><h4>Working Copy</h4><p><a href="https://apps.apple.com/us/app/working-copy-git-client/id896694807">Working Copy</a> is a Git client for iOS that exposes Shortcuts hooks. Using it, we can build a shortcut that does what we need:</p><ol><li>(Working Copy) Pull from <code>twos.dev</code> remote</li><li>(Files) Get contents of folder <code>Published</code></li><li>Repeat with each item in <code>Contents of Folder</code><ol><li>(Working Copy) Write <code>Repeat Item</code> to <code>src</code> in <code>twos.dev</code></li></ol></li><li>(Working Copy) Commit <code>twos.dev</code> with <code>Automatic commit by iA Writer sync job</code></li><li>(Working Copy) Push <code>twos.dev</code> to remote</li></ol><p>(<a href="https://www.icloud.com/shortcuts/6580819cd24041a1b7e093cf6cbe5888">see the shortcut</a>)</p><p>My iPhone runs this each time I switch away from iA Writer, so changes are immediately published. If I switch to another iPhone later, it will inherit the behavior without any action on my part.</p><p>We now have glue between iCloud Drive and GitHub Actions.</p><h4>Markdown → HTML</h4><p>This step is straightforward. Using Stripe’s Markdoc library (more on why later), a GitHub Actions workflow renders the Markdown documents into HTML at build time.</p><h3>Custom Content</h3><p>We’ve got our Markdown pipeline set up, but not everything fits neatly into Markdown. For example, <a href="autism.html">Anonymously Autistic</a> uses CSS gradients to render a spectrum. <a href="thepopin.html">The Pop-In</a> uses media queries to show a different image in dark mode.</p><p>To handle these edge cases, we could run superset of Markdown, such as with templating or Markdoc, but that brings up its own issues:</p><ul><li>I’ll inevitably rewrite this infrastructure some years later, and won’t want to rehandle every edge case I’ve ever handled</li><li>When it’s time to write code I want to use <code>$EDITOR</code>, not iA Writer</li><li>twos.dev has a low volume of content—I don’t want to write new templating code for small features that may only be used once</li></ul><p>For these not-quite-Markdown situations, then, <strong>the right option  is to hardcode</strong>. Render the Markdown to HTML once, then edit the HTML by hand and commit it. Chances are good I’ll never touch it again.</p><h4>Implementation</h4><p>To grease the wheels of hardcoding, we’ll set up our GitHub Actions workflow to explicitly allow it:</p><ol><li>Render <code>src/*.md</code> files → <code>dist/*.html</code></li><li>Copy <code>src/*.html</code> files → <code>dist/</code>, overwriting existing files</li></ol><h4>Results</h4><p>Allowing myself this escape hatch is freeing. It has three effects:</p><ul><li>I’m more encouraged to write interactive or otherwise bespoke components, e.g. to prove a point about button animation UX</li><li>Twos.dev is uniformly structured by default, but I’m allowed  case-by-case to break that uniformity when I see fit (e.g. a <a href="cv.html">CV</a> has a unique need for bicolumnar content)</li><li>TODO</li></ul><p>The final architecture:</p><pre>  ┌─────┐ Low touch  ┌───────────┐     ┌──────────────────────────┐
  │ Me  │───────────▣│ iA Writer │     │    Shortcuts for iOS     │
  └─────┘            └───────────┘     │       Automations        │──┐
     │                     │           │          (cron)          │  │
     │High                 │           └──────────────────────────┘  │
     │touch                │                                         │
     │                     │                                         │
     │                     │                     Shortcuts           │
     │                     │            ┌─────────────────────────┐  │
     │                     ■         ┌─■│ Initialize frontmatter  │□─┤
     │              ┌─────────────┐  │  ├─────────────────────────┤  │
     │              │iCloud Drive │──┼─■│      Backfill date      │□─┤
     │              └─────────────┘  │  ├─────────────────────────┤  │
     │                     │         └─■│    Backfill filename    │□─┤
     │                     │            ├─────────────────────────┤  │
     │                     └───────────■│        Git push         │□─┘
     │                                  └─────────────────────────┘
     │         Local development                     │
     │        ┌──────────────────┐                   ▣
     ├───────▣│       Vim        │       ┌───────────────────────┐
     │        ├──────────────────┤       │ Working Copy for iOS  │
     └───────□│       Git        │       │     (Git client)      │
              └──────────────────┘       └───────────────────────┘
                        │                            │
                        │                            ▣
                        │            ┌───────────────────────────────┐
                        └───────────▣│ github.com/glacials/twos.dev  │──┐
                                     └───────────────────────────────┘  │
                                                                        │
                                               GitHub Actions           │
                                        ┌──────────────────────────┐    │
                                        │ Render Markdown to HTML  │▣───┤
                                        ├──────────────────────────┤    │
                                        │ Copy in high touch pages │▣───┤
                                        ├──────────────────────────┤    │
  ┌──────────────────────────────────┐  │  Deploy to GitHub Pages  │▣───┘
  │ Key                              │  └──────────────────────────┘
  │                                  │                │
  │ A ───■ B   Data flows from A → B │                ■
  │ A ───□ B   A invokes B           │         ┌────────────┐
  │                                  │         │  twos.dev  │
  └──────────────────────────────────┘         └────────────┘
</pre><h2>On URLs</h2><p>I use my website as a test bed for interesting technology. As a side effect, content has been lost over the years as it becomes hard to migrate to newly-overhauled versions.</p><p>It so happens that by keeping my writing in these two formats, Markdown and raw HTML/CSS, I make it easy to accomplish my second goal: <a href="https://www.w3.org/Provider/Style/URI">cool URLs don’t change</a>. I’ll never migrate JavaScript frameworks and be too lazy to move things forward, or move to a database-backed writing system while being unable to simply <code>cp -r</code> these files into the <code>public</code> directory.</p><p>If I’ve done things right, this web page will be accessible at twos.dev/meta.html until the day I die—<a href="death.html">and then some</a>.</p><h3>Extra Credit</h3><p>TODO: Frontmatter</p></article>

    <footer>
      &larr; <a href="index.html">twos.dev</a> /
      
        <a href="https://github.com/glacials/twos.dev/blob/main/src/meta.html">Source</a>
      
    </footer>
  </div></body>
</html>
